# Cards56 Web Application
## About this project
This is a multi-player online card game web application written in .NET core and Java Script.

## Running this application in docker

1. Register a  domain name at any one of the numerous providers. I used google domains and registered 56cards.net for this application.

2. Install and configure SSL certificate. I used a free certificate from https://letsencrypt.org. Here are the steps to get a certificate.

3. Install `certbot` on Ubuntu 20.04 server.
```
sudo apt-get remove certbot
sudo snap install --classic certbot
sudo ln -s /snap/bin/certbot /usr/bin/certbot
```
4. Run `certbot` to generate a certificate. Before issueing a certificate, `certbot` will ensure that you do own the domain `56cards.net` (or whichever domain you have). This is done by providing you a long string which you then have to enter at the DNS registration site as a `TXT` value for the key `_acme-challenge`. The command will wait while you do this. 
Since I am using google domains, I entered the TXT value at https://domains.google.com/registrar/56cards.net/dns. Next, confirm that the value has been updated in you domain registration. You can do this by checking https://toolbox.googleapps.com/apps/dig/#TXT/_acme-challenge.56cards.net.
Once you have confirmed that the value has been set, you can press enter on the waiting `certbot` command. It will then proceed to confirm the DNS TXT value and if everything goes well, it will issue a certificate. In my case, the certificate was stored in `~/docker/ssl/config/live/56cards.net/`. Here is the command I used:
```
certbot certonly --manual --preferred-challenges=dns --email myemail@gmail.com \
  --server https://acme-v02.api.letsencrypt.org/directory --agree-tos \
  --domain "56cards.net" \
  --work-dir ~/docker/ssl/work \
  --config-dir ~/docker/ssl/config \
  --logs-dir ~/docker/ssl/logs
```

5. ASP.NET applications need a certificate in `.pfx` format which is not readily generated by `certbot`. Use openssl to generate a PFX certificate. openssl will ask you for a password to encrypt the PFX. This password will be needed later on. Lets say I used `crypticpassword`.
```
openssl pkcs12 -inkey ~/docker/ssl/config/live/56cards.net/privkey.pem \
        -in ~/docker/ssl/config/live/56cards.net/cert.pem -export \
        -export -passout pass:crypticpassword \
        -out ~/docker/ssl/config/live/56cards.net/cert.pfx
```

6. Let's Encrypt certificates expire every 3 months and needs to be renewed. You can user `certbot` to renew the certificate.
```
/usr/bin/certbot renew --work-dir ~/docker/ssl/work \
  --config-dir ~/docker/ssl/config \
  --logs-dir ~/docker/ssl/logs
```

7. Create `docker-compose.yml`. Here is an example that you can modify and use.
```YML
version: "3"
services:
    web:
        image: bheemboy/cards56web
        container_name: cards56web
        restart: unless-stopped
        dns:
            - 1.1.1.1
        ports:
            - "5000:80"
            - "5001:443"
        environment:
            - TZ=America/Los_Angeles
            - ASPNETCORE_URLS=https://+;http://+
            - ASPNETCORE_Kestrel__Certificates__Default__Password=crypticpassword
            - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/cert.pfx
        volumes:
            - ~/docker/ssl/config/live/56cards.net:/https:ro
```

8. Run docker-compose to download the image from docker hub and start it.
```
docker-compose -f docker-compose.yml up -d
```

## WINDOWS: Setting up development environment for this project

1. Download and install asp.net core 3.1 sdk

2. Download and install Visual Studio Code

3. Clone the source code
```
git clone https://github.com/bheemboy/Cards56.git
cd Cards56
```
4. When running in development mode you need to generate and store a dev certificate for the web application. You can do this using the following commands. Replace `crypticpassword` appropriately.
```
dotnet dev-certs https -ep $env:USERPROFILE\.aspnet\https\cert.pfx -p crypticpassword
dotnet dev-certs https --trust
```
5. Next you need to save the same password for Cards56Web.csproj in your .net user secrets. You can use the following command.
```
dotnet user-secrets -p Cards56web\Cards56Web.csproj set "Kestrel:Certificates:Development:Password" "crypticpassword"
```
6. You should be now ready to load and run/debug the application in docker and/or in VSCode.

## Mint 20.1 (UBUNTU 20.04): Setting up development environment for this project

1. Add Microsoft package signing key to your list of trusted keys and add the package repository.
```
wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
sudo dpkg -i packages-microsoft-prod.deb
```
2. Install asp.net core 3.1 sdk
```
sudo apt-get update; \
  sudo apt-get install -y apt-transport-https && \
  sudo apt-get update && \
  sudo apt-get install -y dotnet-sdk-3.1
```
3. Download and install Visual Studio Code

4. Clone the source code
```
git clone https://github.com/bheemboy/Cards56.git
cd Cards56
```
5. When running in development mode you need to generate and store a dev certificate for the web application. Unfortunately, for this you need some commands in .net core 5.0 SDK. 
```
sudo apt-get install -y dotnet-sdk-5.0
```
6. Generate certificate using openssl
```
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
               -keyout ~/.aspnet/https/cert.key \
               -out ~/.aspnet/https/cert.crt \
               -config ubuntu-ssl-localhost.conf
```
7. Register the certificate with Linux
```
sudo cp ~/.aspnet/https/cert.crt /usr/local/share/ca-certificates
sudo update-ca-certificates
```
8. Verify that the certificate is being recognized
```
openssl verify ~/.aspnet/https/cert.crt
```
9. Export the CRT certificate to pfx format. Replace `crypticpassword` appropriately.
```
openssl pkcs12 -export -out ~/.aspnet/https/cert.pfx -inkey ~/.aspnet/https/cert.key -in ~/.aspnet/https/cert.crt -passout pass:crypticpassword
```
10. Import the PFX certificate into dotnet and check it.
```
dotnet dev-certs https --clean --import ~/.aspnet/https/cert.pfx -p crypticpassword
dotnet dev-certs https --check -v
```
11. Now you can remove .net core SDK 5.0, if you want
```
sudo apt-get remove dotnet-sdk-5.0
sudo apt autoremove
```
12. Next you need to save the same password for Cards56Web.csproj in your .net user secrets. You can use the following command.
```
dotnet user-secrets -p Cards56web\Cards56Web.csproj set "Kestrel:Certificates:Development:Password" "crypticpassword"
```
13. You should be now ready to load and run/debug the application in docker and/or in VSCode.
